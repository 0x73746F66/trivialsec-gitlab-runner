FROM python:3.7-slim AS build
ARG RELEASE
WORKDIR /build
RUN apt-get update && \
    apt-get install -y \
    tar \
    wget && \
    wget -q -c https://github.com/cve-search/cve-search/archive/v${RELEASE}.tar.gz -O - | tar -xz -C /build/ && \
    apt-get clean && \
    rm -rf /tmp/* /var/lib/apt/lists/*

FROM python:3.7-slim
ARG RELEASE
ARG CONF_PATH=configuration-dev.ini
ENV CONF_PATH=${CONF_PATH}
WORKDIR /srv/app

COPY --from=build /build/cve-search-${RELEASE} /srv/app
COPY requirements.txt requirements.txt
RUN pip install -U pip && \
    apt-get update && \
    apt-get install -y \
    gcc && \
    apt-get clean && \
    rm -rf /tmp/* /var/lib/apt/lists/* && \
    pip install -q --no-cache-dir --isolated -r requirements.txt

COPY ${CONF_PATH} /srv/app/etc/configuration.ini

EXPOSE 5180
WORKDIR /srv/app/web
ENTRYPOINT ["python"]
CMD ["index.py"]

LABEL com.trivialsec.version="0.0.1"
LABEL com.trivialsec.release-date="2020-02-23"
